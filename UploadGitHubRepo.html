<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repository Sync Tool | GK Foundation</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 50%, #bbe1fa 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 120px);
            gap: 1rem;
            padding: 1rem;
        }
        
        .pane {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .pane-header {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .pane-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .pane-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .local-pane {
            border-left: 4px solid #28a745;
        }
        
        .github-pane {
            border-left: 4px solid #007bff;
        }
        
        /* File Browser Styles */
        .folder-tree {
            margin-bottom: 1rem;
        }
        
        .folder-item, .file-item {
            padding: 0.5rem;
            margin: 0.2rem 0;
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .folder-item:hover, .file-item:hover {
            background: rgba(15, 76, 117, 0.1);
        }
        
        .folder-item.selected, .file-item.selected {
            background: rgba(15, 76, 117, 0.2);
            border-left: 3px solid #0f4c75;
        }
        
        .folder-item {
            font-weight: 600;
            color: #0f4c75;
        }
        
        .file-item {
            color: #666;
            margin-left: 1rem;
        }
        
        .file-item.html {
            color: #e74c3c;
        }
        
        .expand-icon {
            width: 12px;
            transition: transform 0.2s ease;
        }
        
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        
        /* GitHub Configuration */
        .github-config {
            background: rgba(0, 123, 255, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #0f4c75;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3282b8;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: #212529;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            min-width: 36px;
            height: 36px;
            padding: 6px 8px;
            font-size: 14px;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Path Mapping */
        .path-mapping {
            background: rgba(40, 167, 69, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .path-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 0.5rem 0;
        }
        
        .path-arrow {
            font-size: 1.2rem;
            color: #28a745;
        }
        
        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 600;
            display: none;
        }
        
        .status-success {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        
        .status-error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        .status-info {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
            border: 1px solid rgba(0, 123, 255, 0.3);
        }
        
        /* Sync Progress */
        .sync-progress {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745, #20c997);
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .sync-details {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.5rem;
        }
        
        /* Repository Structure */
        .repo-structure {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .repo-item {
            padding: 0.3rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .repo-folder {
            color: #0f4c75;
            font-weight: 600;
        }
        
        .repo-file {
            color: #666;
            margin-left: 1rem;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .pane {
                min-height: 400px;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
        
        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3282b8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* File Preview */
        .file-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîÑ GitHub Repository Sync Tool</h1>
        <p>Seamlessly sync your local development with GitHub repositories</p>
    </div>
    
    <div class="main-container">
        <!-- Local Folder Browser (Left Pane) -->
        <div class="pane local-pane">
            <div class="pane-header">
                <div class="pane-title">
                    üìÅ Local Project Structure
                </div>
                <button class="btn btn-success" onclick="refreshLocalStructure()">
                    üîÑ Refresh
                </button>
            </div>
            <div class="pane-content">
                <div class="form-group">
                    <label for="localPath">üìÇ Project Root Path:</label>
                    <input type="text" id="localPath" value="C:\Ga\GAMMA\GAMMATHREE" 
                           placeholder="Enter your local project path">
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="browseLocalFolder()">
                        üìÇ Browse Folder
                    </button>
                    <button class="btn btn-info" onclick="scanLocalStructure()">
                        üîç Scan Structure
                    </button>
                </div>
                
                <!-- File Drop Zone -->
                <div id="fileDropZone" class="file-drop-zone" style="display: none; margin-top: 1rem; padding: 2rem; border: 2px dashed #8b4513; border-radius: 8px; text-align: center; background: rgba(139, 69, 19, 0.05);">
                    <div class="drop-zone-content">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #8b4513; margin-bottom: 1rem;"></i>
                        <h3 style="color: #8b4513; margin-bottom: 1rem;">Drop HTML Files Here</h3>
                        <p style="color: #666; margin-bottom: 1rem;">Or click to browse files from your computer</p>
                        <input type="file" id="fileInput" multiple accept=".html,.htm,.css,.js,.md,.txt" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            üìÅ Select Files
                        </button>
                        <div id="loadedFiles" style="margin-top: 1rem; text-align: left;"></div>
                    </div>
                </div>
                
                <div id="localStructure" class="folder-tree">
                    <!-- Local folder structure will be populated here -->
                </div>
                
                <div id="selectedLocalFiles" class="path-mapping">
                    <h4>üìã Selected Files for Sync:</h4>
                    <div id="selectedFilesList">
                        <p style="color: #666; font-style: italic;">No files selected yet</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GitHub Repository Browser (Right Pane) -->
        <div class="pane github-pane">
            <div class="pane-header">
                <div class="pane-title">
                    üêô GitHub Repository
                </div>
                <button class="btn btn-primary" onclick="connectToGitHub()">
                    üîó Connect
                </button>
            </div>
            <div class="pane-content">
                <div class="github-config">
                    <div class="form-group">
                        <label for="githubToken">üîë GitHub Personal Access Token:</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="password" id="githubToken" 
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                                   style="flex: 1;">
                            <button type="button" id="toggleTokenBtn" class="btn btn-secondary" 
                                    onclick="toggleTokenVisibility()" title="Show/Hide Token">
                                üëÅÔ∏è
                            </button>
                            <button type="button" id="saveTokenBtn" class="btn btn-secondary" 
                                    onclick="saveToken()" title="Save Token">
                                üíæ
                            </button>
                            <button type="button" id="loadTokenBtn" class="btn btn-secondary" 
                                    onclick="loadToken()" title="Load Saved Token">
                                üì•
                            </button>
                            <button type="button" id="clearTokenBtn" class="btn btn-secondary" 
                                    onclick="clearSavedToken()" title="Clear Saved Token">
                                üóëÔ∏è
                            </button>
                        </div>
                        <small style="color: #666;">
                            Generate at: <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings ‚Üí Tokens</a>
                            | <span id="tokenStatus" style="color: #28a745;"></span>
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="githubUsername">üë§ GitHub Username:</label>
                        <input type="text" id="githubUsername" placeholder="your-username">
                    </div>
                    
                    <div class="form-group">
                        <label for="githubRepo">üì¶ Repository Name:</label>
                        <input type="text" id="githubRepo" value="GAMMATHREE-CONTENT" 
                               placeholder="repository-name">
                    </div>
                    
                    <div class="form-group">
                        <label for="githubBranch">üåø Branch:</label>
                        <select id="githubBranch">
                            <option value="main">main</option>
                            <option value="master">master</option>
                            <option value="gh-pages">gh-pages</option>
                            <option value="develop">develop</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="targetPath">üéØ Target Path in Repository:</label>
                        <input type="text" id="targetPath" value="content/" 
                               placeholder="content/ (leave empty for root)">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="testGitHubConnection()">
                        üß™ Test Connection
                    </button>
                    <button class="btn btn-info" onclick="loadRepositoryStructure()">
                        üìÇ Load Repository
                    </button>
                    <button class="btn btn-warning" onclick="createRepository()">
                        ‚ûï Create New Repo
                    </button>
                </div>
                
                <div id="repoStructure" class="repo-structure">
                    <p style="color: #666; font-style: italic;">Connect to GitHub to view repository structure</p>
                </div>
                
                <div class="path-mapping">
                    <h4>üó∫Ô∏è Path Mapping Preview:</h4>
                    <div id="pathMappingPreview">
                        <div class="path-row">
                            <span>üìÅ Local: /Guruvammal-Database/Languages/French/</span>
                            <span class="path-arrow">‚Üí</span>
                            <span>üìÅ GitHub: /content/languages/french/</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sync Controls (Bottom Panel) -->
    <div style="background: rgba(255,255,255,0.95); padding: 1rem; margin: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
                <h3 style="color: #0f4c75; margin-bottom: 0.5rem;">üöÄ Sync Operations</h3>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="startSync()">
                        ‚¨ÜÔ∏è Upload Selected
                    </button>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 5px; font-size: 14px;">
                            <input type="checkbox" id="forceOverride" checked style="margin: 0;">
                            <span>üîÑ Force Override (Skip SHA checks)</span>
                        </label>
                    </div>
                    <button class="btn btn-success" onclick="startUploadProcess()" 
                            style="background: linear-gradient(135deg, #ff6b35, #f7931e); border: 2px solid #ff6b35;">
                        üöÄ Upload All Folders & Files
                    </button>
                    <button class="btn btn-info" onclick="compareChanges()">
                        üîç Compare Changes
                    </button>
                    <button class="btn btn-warning" onclick="downloadChanges()">
                        ‚¨áÔ∏è Download Updates
                    </button>
                    <button class="btn btn-primary" onclick="syncBothWays()">
                        üîÑ Bidirectional Sync
                    </button>
                </div>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="autoResolveConflicts" checked> 
                    Auto-resolve path conflicts
                </label><br>
                <label>
                    <input type="checkbox" id="preserveStructure" checked> 
                    Preserve folder structure
                </label>
            </div>
        </div>
        
        <div class="sync-progress" id="syncProgress">
            <h4>üìä Sync Progress</h4>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="sync-details" id="syncDetails">
                Preparing sync...
            </div>
        </div>
        
        <div class="status-message" id="statusMessage"></div>
    </div>
    
    <script>
        // Global variables
        let localStructure = {};
        let githubStructure = {};
        let selectedFiles = [];
        let githubApi = null;
        
        // Enhanced GitHub operations with better debugging
        async function connectToGitHub() {
            console.log('üîó Connect button clicked - starting connection process...');
            
            const token = document.getElementById('githubToken').value.trim();
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            
            console.log('üìã Configuration check:', {
                tokenLength: token ? token.length : 0,
                tokenPrefix: token ? token.substring(0, 4) + '...' : 'empty',
                username: username || 'empty',
                repo: repo || 'empty'
            });
            
            // Enhanced validation with specific messages
            if (!token) {
                const message = 'üîë GitHub token is required. Please paste your token.';
                showStatus(message, 'error');
                console.error('‚ùå Missing token');
                return;
            }
            
            if (!username) {
                const message = 'üë§ GitHub username is required. Please enter your username.';
                showStatus(message, 'error');
                console.error('‚ùå Missing username');
                return;
            }
            
            if (!repo) {
                const message = 'üì¶ Repository name is required. Please enter repository name.';
                showStatus(message, 'error');
                console.error('‚ùå Missing repository name');
                return;
            }
            
            // Validate token format
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                const message = '‚ùå Invalid token format. Token should start with "ghp_" or "github_pat_"';
                showStatus(message, 'error');
                console.error('‚ùå Invalid token format');
                return;
            }
            
            showStatus('üîó Connecting to GitHub...', 'info');
            console.log('üöÄ Starting GitHub API connection...');
            
            try {
                // Create GitHub API instance
                githubApi = new GitHubAPI(token, username, repo);
                console.log('‚úÖ GitHub API instance created');
                
                // Test connection by getting repository info
                console.log('üì° Testing connection with repository API call...');
                const repoInfo = await githubApi.getRepository();
                console.log('‚úÖ Repository info received:', {
                    name: repoInfo.name,
                    fullName: repoInfo.full_name,
                    private: repoInfo.private,
                    defaultBranch: repoInfo.default_branch
                });
                
                // Update UI with success
                const successMessage = `‚úÖ Connected to ${repoInfo.full_name}`;
                showStatus(successMessage, 'success');
                console.log('üéâ Connection successful!');
                
                // Update button to show connected state
                const connectBtn = document.querySelector('button[onclick="connectToGitHub()"]');
                if (connectBtn) {
                    connectBtn.innerHTML = '‚úÖ Connected';
                    connectBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                }
                
                // Auto-load repository structure
                setTimeout(() => {
                    console.log('üìÇ Auto-loading repository structure...');
                    loadRepositoryStructure();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå GitHub connection failed:', error);
                
                let errorMessage = '‚ùå Connection failed: ';
                
                // Provide specific error messages based on error type
                if (error.message.includes('401')) {
                    errorMessage += 'Invalid token or insufficient permissions. Please check your token.';
                } else if (error.message.includes('404')) {
                    errorMessage += 'Repository not found. Please check username and repository name.';
                } else if (error.message.includes('403')) {
                    errorMessage += 'Access forbidden. Your token may lack required permissions.';
                } else if (error.message.includes('network') || error.message.includes('fetch')) {
                    errorMessage += 'Network error. Please check your internet connection.';
                } else {
                    errorMessage += error.message;
                }
                
                showStatus(errorMessage, 'error');
                
                // Reset button state
                const connectBtn = document.querySelector('button[onclick="connectToGitHub()"]');
                if (connectBtn) {
                    connectBtn.innerHTML = 'üîó Connect';
                    connectBtn.style.background = '';
                }
                
                // Show troubleshooting help
                console.log('üõ†Ô∏è Troubleshooting help:');
                console.log('1. Verify token is correct and has "repo" scope');
                console.log('2. Check username spelling');
                console.log('3. Ensure repository exists and is accessible');
                console.log('4. Try creating repository first if it doesn\'t exist');
            }
        }
        
        // Enhanced GitHubAPI class with better error handling
        class GitHubAPI {
            constructor(token, username, repo) {
                this.token = token;
                this.username = username;
                this.repo = repo;
                this.baseURL = 'https://api.github.com';
                
                console.log('üèóÔ∏è GitHubAPI initialized:', {
                    username: this.username,
                    repo: this.repo,
                    baseURL: this.baseURL
                });
            }
            
            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                console.log(`üì° API Request: ${options.method || 'GET'} ${url}`);
                
                const defaultOptions = {
                    headers: {
                        'Authorization': `Bearer ${this.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                        'User-Agent': 'GAMMATHREE-Sync-Tool'
                    }
                };
                
                const requestOptions = { ...defaultOptions, ...options };
                console.log('üìã Request headers:', Object.keys(requestOptions.headers));
                
                try {
                    const response = await fetch(url, requestOptions);
                    console.log(`üì• Response: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            errorData = { message: errorText };
                        }
                        
                        console.error('‚ùå API Error:', {
                            status: response.status,
                            statusText: response.statusText,
                            error: errorData
                        });
                        
                        const error = new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                        error.status = response.status;
                        error.response = errorData;
                        throw error;
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ API Success:', typeof data, Array.isArray(data) ? `Array(${data.length})` : 'Object');
                    return data;
                    
                } catch (error) {
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        console.error('‚ùå Network error:', error);
                        throw new Error('Network error: Unable to connect to GitHub. Please check your internet connection.');
                    }
                    throw error;
                }
            }
            
            async getRepository() {
                console.log('üì¶ Getting repository information...');
                return this.request(`/repos/${this.username}/${this.repo}`);
            }
            
            async getContents(path = '', branch = 'main') {
                console.log(`üìÇ Getting contents: path="${path}", branch="${branch}"`);
                const endpoint = `/repos/${this.username}/${this.repo}/contents/${path}`;
                return this.request(`${endpoint}?ref=${branch}`);
            }
            
            async createOrUpdateFile(path, content, message, branch = 'main', sha = null, forceOverride = false) {
                console.log(`üìù Creating/updating file: ${path}`);
                const endpoint = `/repos/${this.username}/${this.repo}/contents/${path}`;
                const body = {
                    message,
                    content: btoa(unescape(encodeURIComponent(content))), // Base64 encode
                    branch
                };
                
                // If force override is enabled and no SHA provided, try to get it automatically
                if (forceOverride && !sha) {
                    try {
                        const existingFile = await this.getContents(path, branch);
                        if (existingFile && existingFile.sha) {
                            sha = existingFile.sha;
                            console.log(`üîÑ Force override - auto-retrieved SHA: ${sha.substring(0, 8)}...`);
                        }
                    } catch (error) {
                        // File doesn't exist, continue without SHA (new file)
                        if (!error.message.includes('404')) {
                            console.warn(`‚ö†Ô∏è Could not auto-retrieve SHA: ${error.message}`);
                        }
                    }
                }
                
                if (sha) {
                    body.sha = sha;
                }
                
                return this.request(endpoint, {
                    method: 'PUT',
                    body: JSON.stringify(body)
                });
            }
            
            async createRepository(description = 'Content repository') {
                console.log('üèóÔ∏è Creating new repository...');
                return this.request('/user/repos', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: this.repo,
                        description,
                        private: false,
                        auto_init: true
                    })
                });
            }
            
            async getBranches() {
                console.log('üåø Getting repository branches...');
                return this.request(`/repos/${this.username}/${this.repo}/branches`);
            }
        }
        
        // Local file system simulation (for demo purposes)
        // In a real implementation, you'd use File System Access API or Electron
        function simulateLocalStructure() {
            return {
                'Guruvammal-Database': {
                    type: 'folder',
                    children: {
                        'Languages': {
                            type: 'folder',
                            children: {
                                'French': {
                                    type: 'folder',
                                    children: {
                                        'GA_FR_Alphabets_Accents.html': { type: 'file', size: 85432 },
                                        'GA_FR_Numbers_1_to_100.html': { type: 'file', size: 67543 },
                                        'GA_FR_Beginner_Greetings.html': { type: 'file', size: 45123 },
                                        'GA_FR_Beg_Vocabulary.html': { type: 'file', size: 78965 }
                                    }
                                },
                                'English': {
                                    type: 'folder',
                                    children: {
                                        'GA_EN_Alphabets_Accents.html': { type: 'file', size: 73245 },
                                        'GA_EN_Numbers_1_to_100.html': { type: 'file', size: 56789 }
                                    }
                                },
                                'Tamil': {
                                    type: 'folder',
                                    children: {
                                        'GS_TA_Alphabets_Accents.html': { type: 'file', size: 89123 }
                                    }
                                },
                                'French_learning_intro.html': { type: 'file', size: 123456 }
                            }
                        },
                        'IELTS': {
                            type: 'folder',
                            children: {
                                'General': {
                                    type: 'folder',
                                    children: {
                                        'Listening': {
                                            type: 'folder',
                                            children: {
                                                'IELTS_G_Listening_Part1.html': { type: 'file', size: 234567 }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                'index.html': { type: 'file', size: 345678 },
                'README.md': { type: 'file', size: 12345 }
            };
        }
        
        // Initialize the application
        function initializeApp() {
            console.log('üöÄ GitHub Repository Sync Tool initialized');
            loadLocalStructure();
            setupEventListeners();
            initializeTokenManagement();
        }
        
        function setupEventListeners() {
            // Auto-save GitHub configuration
            ['githubToken', 'githubUsername', 'githubRepo', 'githubBranch', 'targetPath'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', saveConfiguration);
                }
            });
            
            // Load saved configuration
            loadConfiguration();
        }
        
        function saveConfiguration() {
            const config = {
                githubUsername: document.getElementById('githubUsername').value,
                githubRepo: document.getElementById('githubRepo').value,
                githubBranch: document.getElementById('githubBranch').value,
                targetPath: document.getElementById('targetPath').value
            };
            
            localStorage.setItem('githubSyncConfig', JSON.stringify(config));
            console.log('üíæ Configuration saved');
        }
        
        function loadConfiguration() {
            const saved = localStorage.getItem('githubSyncConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    Object.keys(config).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && config[key]) {
                            element.value = config[key];
                        }
                    });
                    console.log('üìã Configuration loaded');
                } catch (error) {
                    console.error('‚ùå Error loading configuration:', error);
                }
            }
        }
        
        // Local structure management
        function loadLocalStructure() {
            localStructure = simulateLocalStructure();
            renderLocalStructure();
        }
        
        function renderLocalStructure(structure = localStructure, container = null, level = 0) {
            if (!container) {
                container = document.getElementById('localStructure');
                container.innerHTML = '';
            }
            
            Object.keys(structure).forEach(name => {
                const item = structure[name];
                const itemElement = document.createElement('div');
                itemElement.style.marginLeft = `${level * 20}px`;
                
                if (item.type === 'folder') {
                    itemElement.className = 'folder-item';
                    itemElement.innerHTML = `
                        <span class="expand-icon">‚ñ∂</span>
                        <span>üìÅ ${name}</span>
                    `;
                    itemElement.onclick = () => toggleFolder(itemElement, item.children, level + 1);
                } else {
                    itemElement.className = 'file-item html';
                    itemElement.innerHTML = `
                        <span>üìÑ ${name}</span>
                        <small style="margin-left: auto; color: #999;">
                            ${formatFileSize(item.size)}
                        </small>
                    `;
                    itemElement.onclick = () => selectFile(itemElement, name, getCurrentPath(itemElement));
                }
                
                container.appendChild(itemElement);
            });
        }
        
        function toggleFolder(folderElement, children, level) {
            const expandIcon = folderElement.querySelector('.expand-icon');
            const isExpanded = expandIcon.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse
                expandIcon.classList.remove('expanded');
                let nextSibling = folderElement.nextElementSibling;
                while (nextSibling && nextSibling.style.marginLeft > folderElement.style.marginLeft) {
                    const toRemove = nextSibling;
                    nextSibling = nextSibling.nextElementSibling;
                    toRemove.remove();
                }
            } else {
                // Expand
                expandIcon.classList.add('expanded');
                const tempContainer = document.createElement('div');
                renderLocalStructure(children, tempContainer, level);
                
                let insertAfter = folderElement;
                Array.from(tempContainer.children).forEach(child => {
                    insertAfter.parentNode.insertBefore(child, insertAfter.nextSibling);
                    insertAfter = child;
                });
            }
        }
        
        function selectFile(fileElement, fileName, path) {
            fileElement.classList.toggle('selected');
            const fullPath = path + fileName;
            
            if (fileElement.classList.contains('selected')) {
                selectedFiles.push({
                    name: fileName,
                    path: fullPath,
                    localPath: fullPath,
                    targetPath: transformPathForGitHub(fullPath)
                });
            } else {
                selectedFiles = selectedFiles.filter(f => f.path !== fullPath);
            }
            
            updateSelectedFilesList();
        }
        
        function getCurrentPath(element) {
            // This would calculate the current folder path based on the tree structure
            // For demo purposes, returning a simple path
            return '/Guruvammal-Database/Languages/French/';
        }
        
        function transformPathForGitHub(localPath) {
            const targetBasePath = document.getElementById('targetPath').value || '';
            
            // Transform path to be GitHub-friendly
            let githubPath = localPath
                .replace(/\\/g, '/') // Convert Windows paths
                .replace(/^\/+/, '') // Remove leading slashes
                .toLowerCase() // Make lowercase
                .replace(/\s+/g, '-') // Replace spaces with hyphens
                .replace(/[^a-z0-9\-\/\.]/g, '') // Remove special characters
                .replace(/\/+/g, '/'); // Remove duplicate slashes
            
            return targetBasePath + githubPath;
        }
        
        function updateSelectedFilesList() {
            const container = document.getElementById('selectedFilesList');
            
            if (selectedFiles.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No files selected yet</p>';
                return;
            }
            
            container.innerHTML = selectedFiles.map(file => `
                <div class="path-row">
                    <span>üìÑ ${file.name}</span>
                    <span class="path-arrow">‚Üí</span>
                    <span style="font-family: monospace; color: #007bff;">${file.targetPath}</span>
                    <button onclick="removeSelectedFile('${file.path}')" style="background: none; border: none; color: #dc3545; cursor: pointer; margin-left: 0.5rem;">‚úï</button>
                </div>
            `).join('');
        }
        
        function removeSelectedFile(path) {
            selectedFiles = selectedFiles.filter(f => f.path !== path);
            updateSelectedFilesList();
            
            // Update UI
            const fileElements = document.querySelectorAll('.file-item.selected');
            fileElements.forEach(element => {
                if (element.textContent.includes(path.split('/').pop())) {
                    element.classList.remove('selected');
                }
            });
        }
        
        // GitHub operations
        async function testGitHubConnection() {
            console.log('üß™ Test connection button clicked');
            showStatus('üß™ Testing GitHub connection...', 'info');
            
            try {
                await connectToGitHub();
                console.log('‚úÖ Test completed successfully');
            } catch (error) {
                console.error('‚ùå Test failed:', error);
                showStatus(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        // Token management functions
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('githubToken');
            const toggleBtn = document.getElementById('toggleTokenBtn');
            
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
                toggleBtn.innerHTML = 'üôà';
                toggleBtn.title = 'Hide Token';
                console.log('üëÅÔ∏è Token visibility: shown');
            } else {
                tokenInput.type = 'password';
                toggleBtn.innerHTML = 'üëÅÔ∏è';
                toggleBtn.title = 'Show Token';
                console.log('üôà Token visibility: hidden');
            }
        }
        
        function saveToken() {
            const token = document.getElementById('githubToken').value.trim();
            const username = document.getElementById('githubUsername').value.trim();
            const repo = document.getElementById('githubRepo').value.trim();
            
            if (!token) {
                showStatus('‚ùå No token to save', 'error');
                return;
            }
            
            try {
                const tokenData = {
                    token: token,
                    username: username,
                    repo: repo,
                    savedAt: new Date().toISOString(),
                    tokenPrefix: token.substring(0, 7) + '...'
                };
                
                localStorage.setItem('github_token_data', JSON.stringify(tokenData));
                updateTokenStatus(`üíæ Token saved (${tokenData.tokenPrefix})`);
                showStatus('üíæ Token and credentials saved successfully!', 'success');
                console.log('üíæ Token saved to localStorage:', {
                    tokenPrefix: tokenData.tokenPrefix,
                    username: username,
                    repo: repo,
                    savedAt: tokenData.savedAt
                });
            } catch (error) {
                console.error('‚ùå Error saving token:', error);
                showStatus('‚ùå Failed to save token', 'error');
            }
        }
        
        function loadToken() {
            try {
                const savedData = localStorage.getItem('github_token_data');
                if (!savedData) {
                    showStatus('‚ÑπÔ∏è No saved token found', 'info');
                    updateTokenStatus('');
                    return;
                }
                
                const tokenData = JSON.parse(savedData);
                
                // Load all saved data
                document.getElementById('githubToken').value = tokenData.token;
                if (tokenData.username) {
                    document.getElementById('githubUsername').value = tokenData.username;
                }
                if (tokenData.repo) {
                    document.getElementById('githubRepo').value = tokenData.repo;
                }
                
                // Calculate how long ago it was saved
                const savedDate = new Date(tokenData.savedAt);
                const now = new Date();
                const daysDiff = Math.floor((now - savedDate) / (1000 * 60 * 60 * 24));
                const timeAgo = daysDiff === 0 ? 'today' : 
                               daysDiff === 1 ? '1 day ago' : 
                               `${daysDiff} days ago`;
                
                updateTokenStatus(`üì• Loaded (${tokenData.tokenPrefix}) - saved ${timeAgo}`);
                showStatus(`üì• Token and credentials loaded successfully! (saved ${timeAgo})`, 'success');
                
                console.log('üì• Token loaded from localStorage:', {
                    tokenPrefix: tokenData.tokenPrefix,
                    username: tokenData.username,
                    repo: tokenData.repo,
                    savedAt: tokenData.savedAt,
                    daysAgo: daysDiff
                });
                
            } catch (error) {
                console.error('‚ùå Error loading token:', error);
                showStatus('‚ùå Failed to load saved token', 'error');
                updateTokenStatus('');
            }
        }
        
        function clearSavedToken() {
            try {
                const savedData = localStorage.getItem('github_token_data');
                if (!savedData) {
                    showStatus('‚ÑπÔ∏è No saved token to clear', 'info');
                    return;
                }
                
                localStorage.removeItem('github_token_data');
                updateTokenStatus('');
                showStatus('üóëÔ∏è Saved token cleared successfully!', 'success');
                console.log('üóëÔ∏è Saved token cleared from localStorage');
                
            } catch (error) {
                console.error('‚ùå Error clearing token:', error);
                showStatus('‚ùå Failed to clear saved token', 'error');
            }
        }
        
        function updateTokenStatus(message) {
            const statusElement = document.getElementById('tokenStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }
        
        // Auto-load token on page load
        function initializeTokenManagement() {
            console.log('üîß Initializing token management...');
            
            // Check if there's a saved token
            try {
                const savedData = localStorage.getItem('github_token_data');
                if (savedData) {
                    const tokenData = JSON.parse(savedData);
                    const savedDate = new Date(tokenData.savedAt);
                    const now = new Date();
                    const daysDiff = Math.floor((now - savedDate) / (1000 * 60 * 60 * 24));
                    const timeAgo = daysDiff === 0 ? 'today' : 
                                   daysDiff === 1 ? '1 day ago' : 
                                   `${daysDiff} days ago`;
                    
                    updateTokenStatus(`üíæ Token available (${tokenData.tokenPrefix}) - saved ${timeAgo}`);
                    console.log('üíæ Saved token detected:', {
                        tokenPrefix: tokenData.tokenPrefix,
                        daysAgo: daysDiff
                    });
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è No valid saved token found');
            }
        }
        
        // File loading functionality
        let loadedRealFiles = new Map(); // Store actual file contents
        
        // Load files from the specified project path
        function loadFromProjectPath() {
            return new Promise((resolve) => {
                // Create a file input that can select folders
                const folderInput = document.createElement('input');
                folderInput.type = 'file';
                folderInput.webkitdirectory = true; // This enables folder selection
                folderInput.multiple = true;
                
                folderInput.onchange = async (event) => {
                    const files = event.target.files;
                    if (!files || files.length === 0) {
                        showStatus('‚ùå No folder selected', 'error');
                        resolve();
                        return;
                    }
                    
                    console.log(`üìÇ Loading from project path: ${files.length} files found`);
                    showStatus(`üìÇ Loading project files: ${files.length} files found...`, 'info');
                    
                    // Clear existing loaded files
                    loadedRealFiles.clear();
                    
                    let loadedCount = 0;
                    let skippedCount = 0;
                    
                    // Process all files
                    for (const file of files) {
                        try {
                            // Skip unwanted files and folders
                            const filePath = file.webkitRelativePath || file.name;
                            
                            if (shouldSkipFile(filePath)) {
                                console.log(`‚è≠Ô∏è Skipping: ${filePath}`);
                                skippedCount++;
                                continue;
                            }
                            
                            const content = await file.text();
                            
                            loadedRealFiles.set(filePath, {
                                name: file.name,
                                path: filePath,
                                content: content,
                                size: content.length,
                                lastModified: new Date(file.lastModified),
                                type: getFileType(file.name)
                            });
                            
                            loadedCount++;
                            console.log(`‚úÖ Loaded ${filePath} (${content.length} characters)`);
                            
                            // Update progress
                            if (loadedCount % 10 === 0) {
                                showStatus(`üìÇ Loaded ${loadedCount}/${files.length} files...`, 'info');
                            }
                            
                        } catch (error) {
                            console.error(`‚ùå Error loading ${file.name}:`, error);
                            skippedCount++;
                        }
                    }
                    
                    // Show results
                    displayLoadedFiles();
                    showStatus(`‚úÖ Project loaded! ${loadedCount} files ready, ${skippedCount} skipped`, 'success');
                    
                    // Show the file drop zone with loaded files
                    const dropZone = document.getElementById('fileDropZone');
                    dropZone.style.display = 'block';
                    
                    resolve();
                };
                
                // Add a small delay to ensure proper user interaction context
                setTimeout(() => {
                    folderInput.click();
                }, 100);
            });
        }
        
        function loadEntireFolder() {
            return new Promise((resolve) => {
                // Create a file input that can select folders
                const folderInput = document.createElement('input');
                folderInput.type = 'file';
                folderInput.webkitdirectory = true; // This enables folder selection
                folderInput.multiple = true;
                
                showStatus('üìÇ Select your project folder (GAMMATHREE) to upload everything...', 'info');
                
                folderInput.onchange = async (event) => {
                    const files = event.target.files;
                    if (!files || files.length === 0) {
                        showStatus('‚ùå No folder selected', 'error');
                        resolve();
                        return;
                    }
                    
                    console.log(`üìÇ Loading entire folder: ${files.length} files found`);
                    showStatus(`üìÇ Loading entire folder: ${files.length} files found...`, 'info');
                    
                    // Clear existing loaded files
                    loadedRealFiles.clear();
                    
                    let loadedCount = 0;
                    let skippedCount = 0;
                    
                    // Process all files
                    for (const file of files) {
                        try {
                            // Skip unwanted files and folders
                            const filePath = file.webkitRelativePath || file.name;
                            
                            if (shouldSkipFile(filePath)) {
                                console.log(`‚è≠Ô∏è Skipping: ${filePath}`);
                                skippedCount++;
                                continue;
                            }
                            
                            const content = await file.text();
                            
                            loadedRealFiles.set(filePath, {
                                name: file.name,
                                path: filePath,
                                content: content,
                                size: content.length,
                                lastModified: new Date(file.lastModified),
                                type: getFileType(file.name)
                            });
                            
                            loadedCount++;
                            console.log(`‚úÖ Loaded ${filePath} (${content.length} characters)`);
                            
                            // Update progress
                            if (loadedCount % 10 === 0) {
                                showStatus(`üìÇ Loaded ${loadedCount}/${files.length} files...`, 'info');
                            }
                            
                        } catch (error) {
                            console.error(`‚ùå Error loading ${file.name}:`, error);
                            skippedCount++;
                        }
                    }
                    
                    // Show results
                    displayLoadedFiles();
                    showStatus(`‚úÖ Folder loaded! ${loadedCount} files ready, ${skippedCount} skipped`, 'success');
                    
                    // Show the file drop zone with loaded files
                    const dropZone = document.getElementById('fileDropZone');
                    dropZone.style.display = 'block';
                    
                    resolve();
                };
                
                folderInput.click();
            });
        }
        
        function shouldSkipFile(filePath) {
            const skipPatterns = [
                // Folders to skip
                'node_modules/',
                '.git/',
                '.vscode/',
                'Clean-up/',
                'Backend-Setup/',
                '.DS_Store',
                'Thumbs.db',
                '.gitignore',
                // File types to skip
                '.zip',
                '.rar',
                '.exe',
                '.dll',
                '.tmp',
                '.log'
            ];
            
            return skipPatterns.some(pattern => filePath.includes(pattern));
        }
        
        function getFileType(fileName) {
            const ext = fileName.split('.').pop().toLowerCase();
            const types = {
                'html': 'HTML',
                'htm': 'HTML', 
                'css': 'CSS',
                'js': 'JavaScript',
                'md': 'Markdown',
                'txt': 'Text',
                'xlsx': 'Excel',
                'json': 'JSON'
            };
            return types[ext] || 'Other';
        }
        
        function handleFileSelection(event) {
            const files = event.target.files || event.dataTransfer?.files;
            if (!files || files.length === 0) return;
            
            console.log(`üìÅ Loading ${files.length} files...`);
            showStatus(`üìÅ Loading ${files.length} files...`, 'info');
            
            Array.from(files).forEach(async (file) => {
                try {
                    const content = await file.text();
                    const relativePath = file.webkitRelativePath || file.name;
                    
                    loadedRealFiles.set(relativePath, {
                        name: file.name,
                        path: relativePath,
                        content: content,
                        size: content.length,
                        lastModified: new Date(file.lastModified)
                    });
                    
                    console.log(`‚úÖ Loaded ${file.name} (${content.length} characters)`);
                    
                } catch (error) {
                    console.error(`‚ùå Error loading ${file.name}:`, error);
                }
            });
            
            // Update display
            setTimeout(() => {
                displayLoadedFiles();
                showStatus(`‚úÖ Successfully loaded ${files.length} files with real content!`, 'success');
            }, 500);
        }
        
        function setupDragAndDrop() {
            const dropZone = document.getElementById('fileDropZone');
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(139, 69, 19, 0.1)';
                dropZone.style.borderColor = '#8b4513';
            });
            
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(139, 69, 19, 0.05)';
                dropZone.style.borderColor = '#8b4513';
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = 'rgba(139, 69, 19, 0.05)';
                dropZone.style.borderColor = '#8b4513';
                
                handleFileSelection(e);
            });
        }
        
        function displayLoadedFiles() {
            const container = document.getElementById('loadedFiles');
            
            if (loadedRealFiles.size === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">No files loaded yet</p>';
                return;
            }
            
            // Calculate statistics
            const stats = {
                total: loadedRealFiles.size,
                html: 0,
                css: 0,
                js: 0,
                other: 0,
                totalSize: 0
            };
            
            for (const [path, fileData] of loadedRealFiles) {
                stats.totalSize += fileData.size;
                const type = fileData.type || 'Other';
                if (type === 'HTML') stats.html++;
                else if (type === 'CSS') stats.css++;
                else if (type === 'JavaScript') stats.js++;
                else stats.other++;
            }
            
            const totalSizeMB = (stats.totalSize / (1024 * 1024)).toFixed(2);
            
            let html = `
                <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #28a745;">
                    <h4 style="color: #28a745; margin-bottom: 0.5rem;">‚úÖ Ready to Upload!</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div><strong>${stats.total}</strong> Total Files</div>
                        <div><strong>${stats.html}</strong> HTML</div>
                        <div><strong>${stats.css}</strong> CSS</div>
                        <div><strong>${stats.js}</strong> JS</div>
                        <div><strong>${stats.other}</strong> Other</div>
                        <div><strong>${totalSizeMB}MB</strong> Total Size</div>
                    </div>
                    <button onclick="uploadAllFiles()" class="btn btn-success" style="margin-top: 0.5rem;">
                        üöÄ Upload ${stats.total} Files to GitHub
                    </button>
                </div>
                
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; font-weight: 600; color: #8b4513; margin-bottom: 0.5rem;">
                        üìã View All Files (${loadedRealFiles.size})
                    </summary>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem;">
            `;
            
            for (const [path, fileData] of loadedRealFiles) {
                const sizeKB = Math.round(fileData.size / 1024);
                const typeColor = {
                    'HTML': '#8b4513',
                    'CSS': '#007acc', 
                    'JavaScript': '#f7df1e',
                    'Other': '#666'
                }[fileData.type] || '#666';
                
                html += `
                    <div style="padding: 0.4rem; margin: 0.2rem 0; background: rgba(139, 69, 19, 0.02); border-radius: 4px; border-left: 3px solid ${typeColor};">
                        <div style="font-weight: 600; color: #333; font-size: 0.9rem;">${fileData.name}</div>
                        <div style="font-size: 0.8rem; color: #666;">
                            <span style="color: ${typeColor}; font-weight: 500;">${fileData.type}</span> ‚Ä¢ 
                            ${path} ‚Ä¢ ${sizeKB}KB ‚Ä¢ ${fileData.lastModified.toLocaleDateString()}
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </details>
            `;
            
            container.innerHTML = html;
        }
        

        
        async function loadRepositoryStructure() {
            if (!githubApi) {
                showStatus('Please connect to GitHub first', 'error');
                return;
            }
            
            try {
                showStatus('üìÇ Loading repository structure...', 'info');
                const contents = await githubApi.getContents('', document.getElementById('githubBranch').value);
                
                githubStructure = contents;
                renderRepositoryStructure();
                showStatus('‚úÖ Repository structure loaded', 'success');
            } catch (error) {
                console.error('‚ùå Error loading repository:', error);
                
                // Handle empty repository (404 error is expected for empty repos)
                if (error.message.includes('404') || error.message.includes('empty')) {
                    githubStructure = [];
                    renderRepositoryStructure();
                    showStatus('üìÇ Repository is empty - ready for first upload!', 'success');
                    console.log('‚úÖ Empty repository detected - this is normal for new repos');
                } else {
                    showStatus(`‚ùå Failed to load repository: ${error.message}`, 'error');
                }
            }
        }
        
        function renderRepositoryStructure() {
            const container = document.getElementById('repoStructure');
            
            if (!githubStructure || githubStructure.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">Repository is empty</div>
                        <div style="font-style: italic;">Ready for your first upload! üöÄ</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = githubStructure.map(item => {
                const icon = item.type === 'dir' ? 'üìÅ' : 'üìÑ';
                const className = item.type === 'dir' ? 'repo-folder' : 'repo-file';
                return `<div class="repo-item ${className}">${icon} ${item.name}</div>`;
            }).join('');
        }
        
        async function createRepository() {
            const username = document.getElementById('githubUsername').value;
            const repo = document.getElementById('githubRepo').value;
            const token = document.getElementById('githubToken').value;
            
            if (!token || !username || !repo) {
                showStatus('Please fill in all GitHub configuration fields', 'error');
                return;
            }
            
            try {
                showStatus('üèóÔ∏è Creating repository...', 'info');
                githubApi = new GitHubAPI(token, username, repo);
                
                const newRepo = await githubApi.createRepository('Content repository for GAMMATHREE project');
                showStatus(`‚úÖ Repository created: ${newRepo.html_url}`, 'success');
                
                // Load the new repository structure
                setTimeout(loadRepositoryStructure, 2000);
            } catch (error) {
                console.error('‚ùå Repository creation failed:', error);
                showStatus(`‚ùå Failed to create repository: ${error.message}`, 'error');
            }
        }
        
        // Start the upload process - directly triggered by user click
        function startUploadProcess() {
            if (!githubApi) {
                showStatus('Please connect to GitHub first', 'error');
                return;
            }
            
            const projectPath = document.getElementById('localPath').value.trim();
            
            // If files are already loaded, proceed directly to upload
            if (loadedRealFiles.size > 0) {
                proceedWithUpload(projectPath);
                return;
            }
            
            // Files not loaded - need to load them first
            showStatus(`üìÇ Select your project folder (${projectPath || 'GAMMATHREE'}) to upload all files...`, 'info');
            
            // Create file input directly in the user click context
            const folderInput = document.createElement('input');
            folderInput.type = 'file';
            folderInput.webkitdirectory = true;
            folderInput.multiple = true;
            
            folderInput.onchange = async (event) => {
                const files = event.target.files;
                if (!files || files.length === 0) {
                    showStatus('‚ùå No folder selected', 'error');
                    return;
                }
                
                showStatus(`üìÇ Loading ${files.length} files...`, 'info');
                
                // Clear existing files
                loadedRealFiles.clear();
                
                let loadedCount = 0;
                let skippedCount = 0;
                
                // Process all files
                for (const file of files) {
                    try {
                        const filePath = file.webkitRelativePath || file.name;
                        
                        if (shouldSkipFile(filePath)) {
                            skippedCount++;
                            continue;
                        }
                        
                        const content = await file.text();
                        
                        loadedRealFiles.set(filePath, {
                            name: file.name,
                            path: filePath,
                            content: content,
                            size: content.length,
                            lastModified: new Date(file.lastModified),
                            type: getFileType(file.name)
                        });
                        
                        loadedCount++;
                        
                        if (loadedCount % 10 === 0) {
                            showStatus(`üìÇ Loaded ${loadedCount}/${files.length} files...`, 'info');
                        }
                        
                    } catch (error) {
                        console.error(`‚ùå Error loading ${file.name}:`, error);
                        skippedCount++;
                    }
                }
                
                displayLoadedFiles();
                showStatus(`‚úÖ Loaded ${loadedCount} files, ${skippedCount} skipped`, 'success');
                
                // Show drop zone
                const dropZone = document.getElementById('fileDropZone');
                if (dropZone) dropZone.style.display = 'block';
                
                // Proceed with upload
                setTimeout(() => proceedWithUpload(projectPath), 500);
            };
            
            // Trigger file dialog immediately in user click context
            folderInput.click();
        }
        
        // Proceed with the actual upload
        async function proceedWithUpload(projectPath) {
            const forceOverride = document.getElementById('forceOverride').checked;
            const overrideText = forceOverride ? '\nüîÑ FORCE OVERRIDE MODE: Will overwrite existing files without SHA checks' : '';
            
            const confirmUpload = confirm(`üöÄ Upload ALL ${loadedRealFiles.size} files and folders to GitHub?\n\nFrom: ${projectPath || 'Selected Folder'}\n\nThis will upload:\n- All HTML files with real content\n- All subfolders and their contents\n- Maintain exact folder structure${overrideText}\n\nAre you sure you want to proceed?`);
            
            if (!confirmUpload) {
                showStatus('Upload cancelled by user', 'info');
                return;
            }
            
            await uploadAllFiles();
        }
        
        // Upload All Files functionality - now called after files are loaded
        async function uploadAllFiles() {
            
            console.log('üöÄ Starting full project upload...');
            showStatus('üöÄ Starting full project upload with real content...', 'info');
            
            try {
                // Get all loaded files
                const allFiles = await getAllProjectFiles();
                
                if (allFiles.length === 0) {
                    showStatus('‚ùå No files loaded to upload', 'error');
                    return;
                }
                
                console.log(`üìÅ Uploading ${allFiles.length} files with real content:`, allFiles.map(f => f.targetPath));
                
                const syncProgress = document.getElementById('syncProgress');
                const progressFill = document.getElementById('progressFill');
                const syncDetails = document.getElementById('syncDetails');
                
                syncProgress.style.display = 'block';
                
                let uploadedCount = 0;
                let skippedCount = 0;
                const errors = [];
                
                for (let i = 0; i < allFiles.length; i++) {
                    const file = allFiles[i];
                    const progress = ((i + 1) / allFiles.length) * 100;
                    
                    progressFill.style.width = `${progress}%`;
                    syncDetails.textContent = `Uploading: ${file.name} (${i + 1}/${allFiles.length})`;
                    
                    try {
                        // Get real content directly from loaded files
                        const fileData = loadedRealFiles.get(file.localPath);
                        if (!fileData || !fileData.content) {
                            console.log(`‚ö†Ô∏è Skipping file with no content: ${file.name}`);
                            skippedCount++;
                            continue;
                        }
                        
                        const content = fileData.content;
                        const forceOverride = document.getElementById('forceOverride').checked;
                        
                        // Check if file exists to get SHA for updates (unless force override is enabled)
                        let existingSha = null;
                        if (!forceOverride) {
                            try {
                                const existingFile = await githubApi.getContents(file.targetPath, document.getElementById('githubBranch').value);
                                if (existingFile && existingFile.sha) {
                                    existingSha = existingFile.sha;
                                    console.log(`üìÑ File exists, using SHA: ${existingSha.substring(0, 8)}...`);
                                }
                            } catch (error) {
                                // File doesn't exist, that's fine for new files
                                if (error.message.includes('404')) {
                                    console.log(`üìÑ New file: ${file.targetPath}`);
                                } else {
                                    console.warn(`‚ö†Ô∏è Could not check existing file: ${error.message}`);
                                }
                            }
                        } else {
                            console.log(`üîÑ Force override mode: ${file.targetPath}`);
                        }
                        
                        // Upload to GitHub with real content
                        await githubApi.createOrUpdateFile(
                            file.targetPath,
                            content,
                            `Upload ${file.name} via bulk upload`,
                            document.getElementById('githubBranch').value,
                            existingSha,
                            forceOverride
                        );
                        
                        uploadedCount++;
                        console.log(`‚úÖ Uploaded: ${file.targetPath} (${content.length} characters)`);
                        
                    } catch (error) {
                        console.error(`‚ùå Failed to upload ${file.name}:`, error);
                        errors.push({ file: file.name, error: error.message });
                        
                        // Continue with other files even if one fails
                        continue;
                    }
                    
                    // Small delay to avoid rate limiting (reduced for force override mode)
                    const delay = forceOverride ? 150 : 300;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
                
                // Show results
                let resultMessage = `üéâ Upload Complete!\n‚úÖ Uploaded: ${uploadedCount} files with real content`;
                if (skippedCount > 0) {
                    resultMessage += `\n‚ö†Ô∏è Skipped: ${skippedCount} files`;
                }
                if (errors.length > 0) {
                    resultMessage += `\n‚ùå Errors: ${errors.length} files`;
                    console.error('Upload errors:', errors);
                }
                
                showStatus(resultMessage, uploadedCount > 0 ? 'success' : 'warning');
                
                // Refresh repository view
                setTimeout(() => {
                    loadRepositoryStructure();
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Bulk upload failed:', error);
                showStatus(`‚ùå Bulk upload failed: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    const syncProgress = document.getElementById('syncProgress');
                    if (syncProgress) syncProgress.style.display = 'none';
                }, 3000);
            }
        }
        
        // Get all project files from loaded real files
        async function getAllProjectFiles() {
            const allFiles = [];
            
            if (loadedRealFiles.size === 0) {
                showStatus('‚ùå No files loaded! Please use "üìÇ Load Entire Folder" first.', 'error');
                return [];
            }
            
            // Convert loaded real files to upload format
            for (const [filePath, fileData] of loadedRealFiles) {
                // Clean up the file path for GitHub (remove GAMMATHREE prefix if present)
                let targetPath = filePath;
                
                // Remove the root folder name if it exists in the path
                const pathParts = targetPath.split('/');
                if (pathParts[0] === 'GAMMATHREE' || pathParts[0].includes('GAMMATHREE')) {
                    pathParts.shift(); // Remove first part
                    targetPath = pathParts.join('/');
                }
                
                // Ensure we don't have empty path
                if (!targetPath) {
                    targetPath = fileData.name;
                }
                
                allFiles.push({
                    name: fileData.name,
                    localPath: filePath,
                    targetPath: targetPath,
                    type: 'file',
                    size: fileData.size,
                    fileType: fileData.type
                });
            }
            
            console.log(`üìÅ Found ${allFiles.length} loaded files ready for upload:`, 
                       allFiles.map(f => ({ name: f.name, path: f.targetPath, size: f.size })));
            
            return allFiles;
        }
        
        // Read file content from loaded files in memory
        async function readFileContent(filePath) {
            console.log(`üìñ Reading file: ${filePath}`);
            
            // First check if we already have this file loaded in memory (exact path match)
            if (loadedRealFiles.has(filePath)) {
                const fileData = loadedRealFiles.get(filePath);
                console.log(`‚úÖ Found exact match in loaded files: ${filePath} (${fileData.size} bytes)`);
                return fileData.content;
            }
            
            // Check if file exists in loaded files with different path format
            for (const [loadedPath, fileData] of loadedRealFiles.entries()) {
                // Try different path matching strategies
                const fileName = filePath.split('/').pop();
                const loadedFileName = loadedPath.split('/').pop();
                
                // Match by filename
                if (fileName === loadedFileName) {
                    console.log(`‚úÖ Found by filename match: ${loadedPath} for ${filePath}`);
                    return fileData.content;
                }
                
                // Match if one path ends with the other
                if (loadedPath.endsWith(filePath) || filePath.endsWith(loadedPath)) {
                    console.log(`‚úÖ Found by path suffix match: ${loadedPath} for ${filePath}`);
                    return fileData.content;
                }
                
                // Match if paths are similar (remove common prefixes like GAMMATHREE/)
                const normalizedFilePath = filePath.replace(/^GAMMATHREE\//, '');
                const normalizedLoadedPath = loadedPath.replace(/^GAMMATHREE\//, '');
                
                if (normalizedFilePath === normalizedLoadedPath) {
                    console.log(`‚úÖ Found by normalized path match: ${loadedPath} for ${filePath}`);
                    return fileData.content;
                }
            }
            
            // File not found in loaded files - return placeholder content
            console.warn(`‚ùå File not found in loaded files: ${filePath}. Using placeholder content.`);
            showStatus(`‚ö†Ô∏è File not found: ${filePath}`, 'warning');
            
            // Return a basic HTML placeholder
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Not Found</title>
</head>
<body>
    <h1>File Content Not Available</h1>
    <p>The content for ${filePath} could not be loaded from the selected folder.</p>
    <p>Please ensure the file exists in your project directory and try uploading again.</p>
</body>
</html>`;
        }
        
        // Sync operations
        async function startSync() {
            if (selectedFiles.length === 0) {
                showStatus('Please select files to sync', 'error');
                return;
            }
            
            if (!githubApi) {
                showStatus('Please connect to GitHub first', 'error');
                return;
            }
            
            const syncProgress = document.getElementById('syncProgress');
            const progressFill = document.getElementById('progressFill');
            const syncDetails = document.getElementById('syncDetails');
            
            syncProgress.style.display = 'block';
            
            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    
                    progressFill.style.width = `${progress}%`;
                    syncDetails.textContent = `Uploading: ${file.name} (${i + 1}/${selectedFiles.length})`;
                    
                    // Simulate file content reading (in real implementation, you'd read the actual file)
                    const content = await simulateFileRead(file.localPath);
                    
                    // Upload to GitHub
                    await githubApi.createOrUpdateFile(
                        file.targetPath,
                        content,
                        `Upload ${file.name} via sync tool`,
                        document.getElementById('githubBranch').value
                    );
                    
                    console.log(`‚úÖ Uploaded: ${file.targetPath}`);
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                showStatus(`‚úÖ Successfully uploaded ${selectedFiles.length} files`, 'success');
                loadRepositoryStructure(); // Refresh repository view
                
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                showStatus(`‚ùå Sync failed: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    syncProgress.style.display = 'none';
                }, 2000);
            }
        }
        
        async function simulateFileRead(path) {
            // In a real implementation, you'd read the actual file content
            // For demo purposes, return sample HTML content
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sample Content</title>
</head>
<body>
    <h1>Sample HTML Content</h1>
    <p>This is simulated content for: ${path}</p>
    <p>Generated at: ${new Date().toISOString()}</p>
</body>
</html>`;
        }
        
        async function compareChanges() {
            showStatus('üîç Comparing local and remote changes...', 'info');
            // Implementation for comparing changes would go here
            setTimeout(() => {
                showStatus('‚úÖ No conflicts detected. All files are in sync.', 'success');
            }, 2000);
        }
        
        async function downloadChanges() {
            showStatus('‚¨áÔ∏è Downloading updates from repository...', 'info');
            // Implementation for downloading changes would go here
            setTimeout(() => {
                showStatus('‚úÖ Repository is up to date. No downloads needed.', 'success');
            }, 2000);
        }
        
        async function syncBothWays() {
            showStatus('üîÑ Starting bidirectional sync...', 'info');
            // Implementation for bidirectional sync would go here
            setTimeout(() => {
                showStatus('‚úÖ Bidirectional sync completed successfully.', 'success');
            }, 3000);
        }
        
        // Utility functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Enhanced status display function
        function showStatus(message, type) {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            const statusElement = document.getElementById('statusMessage');
            if (!statusElement) {
                console.error('‚ùå Status element not found!');
                // Create status element if it doesn't exist
                const newStatusElement = document.createElement('div');
                newStatusElement.id = 'statusMessage';
                newStatusElement.className = 'status-message';
                document.body.appendChild(newStatusElement);
                return showStatus(message, type); // Retry with new element
            }
            
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';
            
            // Auto-hide success and error messages
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, type === 'error' ? 8000 : 5000); // Show errors longer
            }
        }
        
        // Additional utility functions for real implementation
        function refreshLocalStructure() {
            showStatus('üîÑ Clearing loaded files to refresh...', 'info');
            
            // Clear loaded files to force reload
            loadedRealFiles.clear();
            
            // Clear the loaded files display
            const loadedFilesContainer = document.getElementById('loadedFiles');
            if (loadedFilesContainer) {
                loadedFilesContainer.innerHTML = '<p style="color: #666; font-style: italic;">No files loaded yet</p>';
            }
            
            // Hide the drop zone
            const dropZone = document.getElementById('fileDropZone');
            if (dropZone) {
                dropZone.style.display = 'none';
            }
            
            showStatus('‚úÖ Refreshed! Click "Upload All Folders & Files" to reload from your project path', 'success');
        }
        
        function browseLocalFolder() {
            showStatus('üìÇ Loading project folder...', 'info');
            loadFromProjectPath();
        }
        
        function scanLocalStructure() {
            const projectPath = document.getElementById('localPath').value.trim();
            if (!projectPath) {
                showStatus('‚ùå Please specify the Project Root Path first', 'error');
                return;
            }
            
            showStatus(`üîç Select your project folder (${projectPath}) to scan...`, 'info');
            loadFromProjectPath();
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        console.log('üîÑ GitHub Repository Sync Tool loaded successfully!');
        console.log('üí° This tool helps you sync local development with GitHub repositories');
        console.log('üéØ Features: Dual-pane interface, path mapping, conflict resolution, and more');
    </script>
</body>
</html> 